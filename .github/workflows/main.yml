name: Check SSL Certificate Expiry

on:
  schedule:
    - cron: "0 16 * * *"
  workflow_dispatch: # 允许手动触发

jobs:
  check-ssl-cert:
    runs-on: ubuntu-latest
    steps:
      - name: Check SSL Certificate Expiry
        run: |
          DOMAIN="meekdai.com"

          echo "正在检查 $DOMAIN 的 SSL 证书过期时间..."

          # 获取证书过期时间
          EXPIRY_DATE=$(echo | openssl s_client -servername $DOMAIN -connect $DOMAIN:443 2>/dev/null \
            | openssl x509 -noout -enddate | cut -d= -f2)

          # 转换为时间戳
          EXPIRY_SECONDS=$(date -d "$EXPIRY_DATE" +%s)
          NOW_SECONDS=$(date +%s)

          # 计算剩余天数
          REMAINING_DAYS=$(( (EXPIRY_SECONDS - NOW_SECONDS) / 86400 ))

          echo "🔒 域名: $DOMAIN"
          echo "📅 证书过期日期: $EXPIRY_DATE"
          echo "⏳ 证书还有 $REMAINING_DAYS 天到期"

          # 如果小于30天，报错并退出
          if [ "$REMAINING_DAYS" -lt 90 ]; then
            echo "⚠️ 证书即将过期，准备发送钉钉通知..."

            MESSAGE="【SSL预警】\n域名: $DOMAIN\n证书到期时间: $EXPIRY_DATE\n剩余: $REMAINING_DAYS 天\n请及时续期。#SSL"

            # 使用 curl 发送钉钉机器人消息
            curl -s \
              -H "Content-Type: application/json" \
              -X POST \
              -d "{\"msgtype\": \"text\", \"text\": {\"content\": \"$MESSAGE\"}}" \
              "$DINGTALK_WEBHOOK"
          fi
