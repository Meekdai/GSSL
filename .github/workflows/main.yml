name: SSL Certificate Expiry

on:
  schedule:
    - cron: "0 16 * * *"
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check-ssl-cert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check SSL expiry
        id: ssl
        run: |
          DOMAIN="meekdai.com"
          EXPIRY_DATE=$(echo | openssl s_client -servername $DOMAIN -connect $DOMAIN:443 2>/dev/null \
              | openssl x509 -noout -enddate | cut -d= -f2)

          echo "ğŸ”’ åŸŸå: $DOMAIN"
          echo "ğŸ“… è¯ä¹¦è¿‡æœŸæ—¥æœŸ: $EXPIRY_DATE"

          EXPIRY_TS=$(date -d "$EXPIRY_DATE" +%s)
          NOW_TS=$(date +%s)
          REMAINING_DAYS=$(( (EXPIRY_TS - NOW_TS) / 86400 ))

          echo "â³ è¯ä¹¦è¿˜æœ‰ $REMAINING_DAYS å¤©åˆ°æœŸ"

          if [ "$REMAINING_DAYS" -lt 90 ]; then
            echo "âŒ è¯ä¹¦å³å°†è¿‡æœŸï¼ˆ$REMAINING_DAYS å¤©ï¼‰ï¼Œè§¦å‘å¤±è´¥ä»¥å‘é€é‚®ä»¶æé†’"
            echo "status=âš ï¸ å³å°†è¿‡æœŸ" >> $GITHUB_OUTPUT
            echo "exit_needed=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… è¯ä¹¦çŠ¶æ€æ­£å¸¸ï¼ˆ$REMAINING_DAYS å¤©ï¼‰"
            echo "status=âœ… æ­£å¸¸" >> $GITHUB_OUTPUT
            echo "exit_needed=false" >> $GITHUB_OUTPUT
          fi

          echo "expiry_date=$EXPIRY_DATE" >> $GITHUB_OUTPUT
          echo "remaining_days=$REMAINING_DAYS" >> $GITHUB_OUTPUT

      - name: Update README.md with SSL info
        run: |
          # ç”Ÿæˆè¡¨æ ¼å†…å®¹
          cat <<EOF > ssl_status.md
| åŸŸå        | è¯ä¹¦è¿‡æœŸæ—¶é—´             | å‰©ä½™å¤©æ•° | çŠ¶æ€         |
|-------------|--------------------------|----------|--------------|
| meekdai.com | ${{ steps.ssl.outputs.expiry_date }} | ${{ steps.ssl.outputs.remaining_days }} å¤© | ${{ steps.ssl.outputs.status }} |
EOF

          # æ›´æ–° README ä¸­å ä½ç¬¦ä¹‹é—´çš„å†…å®¹
          START="<!--SSL_STATUS_START-->"
          END="<!--SSL_STATUS_END-->"
          awk "/$START/{print; print \"\"; system(\"cat ssl_status.md\"); next} /$END/{print; found=1} !found" README.md > NEW_README.md
          mv NEW_README.md README.md

      - name: Commit and Push README if changed
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com

          if [[ `git status --porcelain` ]]; then
            git add README.md
            git commit -m "ğŸ“„ æ›´æ–° SSL çŠ¶æ€ä¿¡æ¯"
            git push
          else
            echo "ğŸ“„ README æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          fi

      - name: Fail if cert expiring within 30 days
        if: ${{ steps.ssl.outputs.exit_needed == 'true' }}
        run: |
          echo "âŒ meekdai.com SSL è¯ä¹¦å°†åœ¨ ${{ steps.ssl.outputs.remaining_days }} å¤©å†…è¿‡æœŸï¼Œè§¦å‘å¤±è´¥"
          exit 1
