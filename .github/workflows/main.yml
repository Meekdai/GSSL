name: Check SSL Certificate Expiry

on:
  schedule:
    - cron: "0 16 * * *"
  workflow_dispatch: # 允许手动触发

jobs:
  check-ssl-cert:
    runs-on: ubuntu-latest
    outputs:
      expire_soon: ${{ steps.check.outputs.expire_soon }}
      expire_msg: ${{ steps.check.outputs.expire_msg }}
    steps:
      - name: Check SSL expiry
        id: check
        run: |
          DOMAIN="meekdai.com"
          EXPIRY_DATE=$(echo | openssl s_client -servername $DOMAIN -connect $DOMAIN:443 2>/dev/null \
            | openssl x509 -noout -enddate | cut -d= -f2)

          EXPIRY_SECONDS=$(date -d "$EXPIRY_DATE" +%s)
          NOW_SECONDS=$(date +%s)
          REMAINING_DAYS=$(( (EXPIRY_SECONDS - NOW_SECONDS) / 86400 ))

          echo "证书剩余天数: $REMAINING_DAYS"
          
          if [ "$REMAINING_DAYS" -lt 90 ]; then
            echo "expire_soon=true" >> $GITHUB_OUTPUT
            echo "expire_msg=❌ 证书将在 $REMAINING_DAYS 天内过期（截止 $EXPIRY_DATE），请尽快续期！" >> $GITHUB_OUTPUT
          else
            echo "expire_soon=false" >> $GITHUB_OUTPUT
          fi

      - name: Fail if expiring soon
        if: ${{ steps.check.outputs.expire_soon == 'true' }}
        run: |
          echo "${{ steps.check.outputs.expire_msg }}"
          exit 1
